# support script

This folder contains the script used to create a support account on FiWare images.

A support account allows to a member of the support team to access a VM, but without the security risks of a backdoor.

## Overall description

The support account make it possible to access to the VM using an ssh key. This key is not sufficient to gain root privileges; a password must also be provided. This password is also useful to gain access to the VM if the network is down, via the console.

Of course, each VM has a different support password. It is generated by the script and then encrypted with a gpg public key. This way, nobody, without the gpg private key, can read the password and an organization can enforce a policy about accessing the VM (e.g. requiring that a support ticket must be open and the support staff be asigned to the ticket).

The script is started when the VM boot. It first check if a key was generated previously (e.g. if the mVM was deployed before and then rebooted) and then print it and finish, but only if the UUID of the VM is the same. That is, a generated password is discarded after creating a snapshot and instantiate a new VM. If there is not a key generated in a previous boot, the support account is created and a sudo entry requiring a password is added. Next step is to try to get the public ssh and gpg keys from the metadata server. If the operation fails (e.g. there is a problem with the network or the user accidentally has modified the userdata and it is not valid), the ssh and gpg public keys stored in the image will be used. Last step is to generate a password, configure the support account, encrypt the password and print the encripted password to console.

### Installation

The file activate_support_account.py must be included in the image and it must be executed at boot. This last may be accomplished in different ways depending of the Linux distribution (e.g. adding a line to rc.local or using systemd, upstart...)

This folder includes shell scripts to create base images with the file injected, using the mainstream versions of several distributions: Ubuntu 12.4 LTS, Ubuntu 14.4 LTS, CentOS 6, CentOS7 and Debian 7. Each script do some additional work for improving the security, for example activating automatic updates. The file download.sh get the mainstream images, with the exception of debian7 image, that must be generated with build-openstack-debian-imag tool from a running Debian system.

The public keys included in the image may be modified changing the contents of the folder activate_support_account.py. To pass a different set of public keys and launching time, add a workload as the content of cloud-init.example to your cloud-init file.

Important, to generate a new GPG pubkey, the name of the key must begin with "FiWare support". The keys can be generated with 'gpg --gen-key' and then exported with 'gpg --armor --output public.gpg --export "FiWare support"
 
The script update_images.py may be used to update existing images (created with the other scripts) to upgrade the script or change the public keys without regenerating all the image.

### Retrieving the password

The script getpassword.py is an example that retrieves the encrypted password from the console log, decrypts it and open a console to the VM using a browser

## License

The script is licensed under Apache v2.0 license.
